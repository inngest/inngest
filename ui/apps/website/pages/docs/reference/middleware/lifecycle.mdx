# Middleware lifecycle <VersionBadge version="v2.0.0+" />

## Registering and order

Middleware can be registered with Inngest clients or functions by providing an array of middleware.

<CodeGroup>
```ts {{ title: "v3" }}
// Adding middleware to a client
const inngest = new Inngest({
  id: "my-app",
  middleware: [errorHandlerMiddleware, loggingMiddleware],
});

// Adding middleware to a function
inngest.createFunction(
  { id: "example", middleware: [dbConnectionMiddleware] },
  { event: "test" },
  async () => {
    // ...
  }
);
```
```ts {{ title: "v2" }}
// Adding middleware to a client
const inngest = new Inngest({
  name: "My App",
  middleware: [errorHandlerMiddleware, loggingMiddleware],
});

// Adding middleware to a function
inngest.createFunction(
  { name: "Example", middleware: [dbConnectionMiddleware] },
  { event: "test" },
  async () => {
    // ...
  }
);
```
</CodeGroup>

Adding middleware contributes to an overall "stack" of middleware. If you register multiple middlewares, the SDK will group and run hooks for each middleware in the following order:

1. Middleware registered on the **client**, in descending order
2. Middleware registered on the **function**, in descending order

For example:

<CodeGroup>
```ts {{ title: "v3" }}
const inngest = new Inngest({
  id: "my-app",
  middleware: [
    logMiddleware, // This is executed first
    errorMiddleware, // This is executed second
  ],
});

inngest.createFunction(
  {
    id: "example",
    middleware: [
      dbSetupMiddleware, // This is executed third
      datadogMiddleware, // This is executed fourth
    ],
  },
  { event: "test" },
  async () => {
    // ...
  }
);
```
```ts {{ title: "v2" }}
const inngest = new Inngest({
  name: "My App",
  middleware: [
    logMiddleware, // This is executed first
    errorMiddleware, // This is executed second
  ],
});

inngest.createFunction(
  {
    name: "Example",
    middleware: [
      dbSetupMiddleware, // This is executed third
      datadogMiddleware, // This is executed fourth
    ],
  },
  { event: "test" },
  async () => {
    // ...
  }
);
```
</CodeGroup>

---

## Hook reference

The `init()` function can return functions for two separate lifecycles to hook into.

<Callout>
ðŸ’¡ All lifecycle and hook functions can be synchronous or `async` functions - the SDK will always wait until a middleware's function has resolved before continuing to the next one.
</Callout>

<Row>
     <Col>
          ### `onFunctionRun` lifecycle

          Triggered when a function is going to be executed.

          <Properties name="Arguments" nested>
               <Property name="ctx" type="object">
                    The input data for the function. Only `event` and `runId` are available at this point.
               </Property>
               <Property name="steps" type="array">
                    An array of previously-completed step objects.

                    <Properties nested collapse>
                      <Property name="data" type="any">
                        The serialized data for this step if it was successful.
                      </Property>
                      <Property name="error" type="any">
                        The serialized error for this step if it failed.
                      </Property>
                    </Properties>
               </Property>
               <Property name="fn" type="InngestFunction">
                    The function that is about to be executed.
               </Property>
               <Property name="reqArgs" type="array" version="v3.9.0+">
                    Arguments passed to the framework's request handler, which are used by the SDK's `serve` handler.
               </Property>
          </Properties>

          <Properties name="Returns" nested>
               <Property name="transformInput" type="function">
                    Called once the input for the function has been set up. This is where you can modify the input before the function starts.

                    Has the same input as the containing `onFunctionRun()` lifecycle function, but with a complete `ctx` object, including `step` tooling.

                    <Properties name="Returns" nested collapse>
                         <Property name="ctx" type="object">
                              An object that will be merged with the existing function input to create a new input.
                         </Property>
                         <Property name="steps" type="array">
                              An array of modified step data to use in place of the current step data.
                         </Property>
                    </Properties>
               </Property>
               <Property name="beforeMemoization" type="function">
                    Called before the function starts to memoize state (running over previously-seen code).
               </Property>
               <Property name="afterMemoization" type="function">
                    Called after the function has finished memoizing state (running over previously-seen code).
               </Property>
               <Property name="beforeExecution" type="function">
                    Called before the function starts to execute (running code seen for the first time).
               </Property>
               <Property name="afterExecution" type="function">
                    Called after the function has finished executing.
               </Property>
               <Property name="transformOutput" type="function">
                    Called after the function has finished executing and before the response is sent back to Inngest. This is where you can modify the output.

                    <Properties name="Arguments" nested collapse>
                         <Property name="result" type="object" required>
                              An object containing the data to be sent back to inngest in the `data` key, and an original `error` (if any) that threw.
                         </Property>
                         <Property name="step" type="object">
                              If this execution ran a step, will be a step that ran.
                         </Property>
                    </Properties>

                    <Properties name="Returns" nested collapse>
                         <Property name="result" type="object">
                              An object containing a `data` key to overwrite the data that will be sent back to Inngest for this step or function.
                         </Property>
                    </Properties>
               </Property>
               <Property name="beforeResponse" type="function">
                    Called after the output has been set and before the response has been sent back to Inngest. Use this to perform any final actions before the request closes.
               </Property>
          </Properties>
     </Col>
     <Col>
          ```ts
          const myMiddleware = new InngestMiddleware({
            name: "My Middleware",
            init({ client, fn }) {
              return {
                onFunctionRun({ ctx, fn, steps }) {
                  return {
                    transformInput({ ctx, fn, steps }) {
                      // ...
                      return {
                        // All returns are optional
                        ctx: { /* extend fn input */ },
                        steps: steps.map(({ data }) => { /* transform step data */ })
                      }
                    },
                    beforeMemoization() {
                      // ...
                    },
                    afterMemoization() {
                      // ...
                    },
                    beforeExecution() {
                      // ...
                    },
                    afterExecution() {
                      // ...
                    },
                    transformOutput({ result, step }) {
                      // ...
                      return {
                        // All returns are optional
                        result: {
                          // Transform data before it goes back to Inngest
                          data: transformData(result.data)
                        }
                      }
                    },
                    beforeResponse() {
                      // ...
                    },
                  };
                },
              };
            },
          });
          ```
     </Col>
</Row>

---

<Row>
     <Col>
          ### `onSendEvent` lifecycle

          Triggered when an event is going to be sent via `inngest.send()` or `step.sendEvent()`.

          <Properties name="Output" nested>
               <Property name="input" type="function">
                    Called before the events are sent to Inngest. This is where you can modify the events before they're sent.
               </Property>
               <Property name="output" type="function">
                    Called after events are sent to Inngest. This is where you can perform any final actions and modify the output from `inngest.send()`.
               </Property>
          </Properties>
     </Col>
     <Col>
          ```ts
          const myMiddleware = new InngestMiddleware({
            name: "My Middleware",
            init: ({ client, fn }) => {
              return {
                onSendEvent() {
                  return {
                    transformInput({ payloads }) {
                      // ...
                    },
                    transformOutput() {
                      // ...
                    },
                  };
                },
              };
            },
          });
          ```
     </Col>
</Row>

