import type { Meta, StoryObj } from '@storybook/react';

import { RunDetailsV2 } from './RunDetailsV2';

const meta = {
  title: 'Components/RunDetailsV2',
  component: RunDetailsV2,
  parameters: {
    themes: {
      themeOverride: 'light',
    },
  },
} satisfies Meta<typeof RunDetailsV2>;

export default meta;

type Story = StoryObj<typeof RunDetailsV2>;

const app = {
  name: 'My app',
};

const fn = {
  name: 'My Function',
} as const;

const run = {
  id: '01HW3TJKGSYHR2KPW16JJ04M1H',
  output: JSON.stringify({ foo: { bar: 'baz' } }),
};

async function sleep(ms: number) {
  return new Promise((resolve) => setTimeout(resolve, ms));
}

async function getOutput(outputID: string) {
  // Simulate fetch delay
  await sleep(200);

  return JSON.stringify({ foo: { bar: 'baz' } });
}

export const SuccessWithoutSteps: Story = {
  args: {
    app,
    fn,
    getResult: getOutput,
    run: {
      ...run,
      trace: {
        attempts: 1,
        endedAt: '2024-04-23T11:26:43.300Z',
        id: '01HW5B7RMP4GSESCWD3VDWE4P0',
        isRoot: true,
        name: 'no-steps-success',
        outputID: 'MDFIVzVDMDVYUVJCWkZKSE02NEJGS01ZS1E=',
        queuedAt: '2024-04-23T11:26:43.260Z',
        startedAt: '2024-04-23T11:26:43.270Z',
        status: 'COMPLETED',
        childrenSpans: [
          {
            attempts: 1,
            endedAt: '2024-04-23T11:26:43.300Z',
            id: '01HW5BFZCRYYN2Y33TSMSR8Z0R',
            isRoot: false,
            name: 'Successful Run',
            outputID: null,
            queuedAt: '2024-04-23T11:26:43.260Z',
            startedAt: '2024-04-23T11:26:43.270Z',
            status: 'COMPLETED',
            stepInfo: null,
            stepOp: null,
            childrenSpans: [],
          },
        ],
      },
    },
  },
};

export const ErrorWithoutSteps: Story = {
  args: {
    app,
    fn,
    getResult: getOutput,
    run: {
      ...run,
      trace: {
        attempts: 1,
        endedAt: '2024-04-23T11:26:43.260Z',
        id: '01HW5B7RMP4GSESCWD3VDWE4P0',
        isRoot: true,
        name: 'no-steps-error',
        outputID: 'MDFIVzVDMUM5RFdTNURQWDlQVjNFWFdERUU=',
        queuedAt: '2024-04-23T11:26:39.260Z',
        startedAt: '2024-04-23T11:26:39.560Z',
        status: 'FAILED',
        childrenSpans: [
          {
            attempts: 5,
            endedAt: '2024-04-23T11:26:43.300Z',
            id: '01HW5BFZCRYYN2Y33TSMSR8Z0R',
            isRoot: false,
            name: 'Failed function',
            outputID: 'MDFIVzVDM0FKRzcxQjc5R00zN0ZCNVdHU1A=',
            queuedAt: '2024-04-23T11:26:39.260Z',
            startedAt: '2024-04-23T11:26:39.560Z',
            status: 'FAILED',
            stepInfo: null,
            stepOp: null,
            childrenSpans: [
              {
                attempts: 1,
                endedAt: '2024-04-23T11:26:40.060Z',
                id: '01HW5C7CRFXA0N6BSM58N1F2YZ',
                isRoot: false,
                name: 'Attempt 1',
                outputID: 'MDFIVzVDN1hQSlFGU0YyOEhRQjEyV0RXS0o=',
                queuedAt: '2024-04-23T11:26:39.260Z',
                startedAt: '2024-04-23T11:26:39.360Z',
                status: 'FAILED',
                stepInfo: null,
                stepOp: null,
              },
              {
                attempts: 1,
                endedAt: '2024-04-23T11:26:40.860Z',
                id: '01HW5C92PSAC8VEXQ6ECGEMDYE',
                isRoot: false,
                name: 'Attempt 2',
                outputID: 'MDFIVzVDOTJQU0FDOFZFWFE2RUNHRU1EWUU=',
                queuedAt: '2024-04-23T11:26:40.060Z',
                startedAt: '2024-04-23T11:26:40.160Z',
                status: 'FAILED',
                stepInfo: null,
                stepOp: null,
              },
              {
                attempts: 1,
                endedAt: '2024-04-23T11:26:41.660Z',
                id: '01HW5C9F7MAKTFY14WF3ZGEV7T',
                isRoot: false,
                name: 'Attempt 3',
                outputID: 'MDFIVzVDOUY3TUFLVEZZMTRXRjNaR0VWN1Q=',
                queuedAt: '2024-04-23T11:26:40.860Z',
                startedAt: '2024-04-23T11:26:40.960Z',
                status: 'FAILED',
                stepInfo: null,
                stepOp: null,
              },
              {
                attempts: 1,
                endedAt: '2024-04-23T11:26:42.460Z',
                id: '01HW5C9X9W4P5ZHA7QZ1S4ZQTV',
                isRoot: false,
                name: 'Attempt 4',
                outputID: 'MDFIVzVDOVg5VzRQNVpIQTdRWjFTNFpRVFY=',
                queuedAt: '2024-04-23T11:26:41.660Z',
                startedAt: '2024-04-23T11:26:41.760Z',
                status: 'FAILED',
                stepInfo: null,
                stepOp: null,
              },
              {
                attempts: 1,
                endedAt: '2024-04-23T11:26:43.260Z',
                id: '01HW5CA8AKGRPR84PFFB1Y6CWF',
                isRoot: false,
                name: 'Attempt 5',
                outputID: 'MDFIVzVDQThBS0dSUFI4NFBGRkIxWTZDV0Y=',
                queuedAt: '2024-04-23T11:26:42.460Z',
                startedAt: '2024-04-23T11:26:42.560Z',
                status: 'FAILED',
                stepInfo: null,
                stepOp: null,
              },
            ],
          },
        ],
      },
    },
  },
};

export const ParallelRecovery: Story = {
  args: {
    app,
    fn,
    getResult: getOutput,
    run: {
      ...run,
      trace: {
        attempts: 1,
        endedAt: '2024-04-23T11:26:43.260Z',
        id: '01HW5CW5E28ZG7GCYSP67ADRND',
        isRoot: true,
        name: 'parallel-recovery',
        outputID: 'MDFIVzVDVzVFMjhaRzdHQ1lTUDY3QURSTkQ=',
        queuedAt: '2024-04-23T11:26:40.260Z',
        startedAt: '2024-04-23T11:26:40.360Z',
        status: 'COMPLETED',
        childrenSpans: [
          {
            attempts: 2,
            endedAt: '2024-04-23T11:26:43.260Z',
            id: '01HW5CY6F5Q3C15CY53Z104WTN',
            isRoot: false,
            name: 'Step_id_1',
            outputID: 'MDFIVzVDWTZGNVEzQzE1Q1k1M1oxMDRXVE4=',
            queuedAt: '2024-04-23T11:26:40.460Z',
            startedAt: '2024-04-23T11:26:40.560Z',
            status: 'COMPLETED',
            stepInfo: null,
            stepOp: 'RUN',
            childrenSpans: [
              {
                attempts: 1,
                endedAt: '2024-04-23T11:26:42.060Z',
                id: '01HW5D1GRC1AAYJXSNFPC16BHM',
                isRoot: false,
                name: 'Attempt 1',
                outputID: 'MDFIVzVEMUdSQzFBQVlKWFNORlBDMTZCSE0=',
                queuedAt: '2024-04-23T11:26:40.460Z',
                startedAt: '2024-04-23T11:26:40.560Z',
                status: 'FAILED',
                stepInfo: null,
                stepOp: 'RUN',
              },
              {
                attempts: 1,
                endedAt: '2024-04-23T11:26:43.260Z',
                id: '01HW5D23MY4MCX421M0RJ7W3AJ',
                isRoot: false,
                name: 'Attempt 2',
                outputID: 'MDFIVzVEMjNNWTRNQ1g0MjFNMFJKN1czQUo=',
                queuedAt: '2024-04-23T11:26:42.060Z',
                startedAt: '2024-04-23T11:26:42.160Z',
                status: 'COMPLETED',
                stepInfo: null,
                stepOp: 'RUN',
              },
            ],
          },
          {
            attempts: 2,
            endedAt: '2024-04-23T11:26:42.260Z',
            id: '01HW5D84D53Z5KVK4Q35QDNTP4',
            isRoot: false,
            name: 'Step_id_2',
            outputID: 'MDFIVzVEODRENTNaNUtWSzRRMzVRRE5UUDQ=',
            queuedAt: '2024-04-23T11:26:40.460Z',
            startedAt: '2024-04-23T11:26:40.560Z',
            status: 'COMPLETED',
            stepInfo: null,
            stepOp: 'RUN',
            childrenSpans: [
              {
                attempts: 1,
                endedAt: '2024-04-23T11:26:41.360Z',
                id: '01HW5D9QNGNY5ZRSPQS0RXKM9Q',
                isRoot: false,
                name: 'Attempt 1',
                outputID: 'MDFIVzVEOVFOR05ZNVpSU1BRUzBSWEtNOVE=',
                queuedAt: '2024-04-23T11:26:40.460Z',
                startedAt: '2024-04-23T11:26:40.560Z',
                status: 'FAILED',
                stepInfo: null,
                stepOp: 'RUN',
              },
              {
                attempts: 1,
                endedAt: '2024-04-23T11:26:42.260Z',
                id: '01HW5DA4CA3NHAG5QFJ3KGPVZX',
                isRoot: false,
                name: 'Attempt 2',
                outputID: 'MDFIVzVEQTRDQTNOSEFHNVFGSjNLR1BWWlg=',
                queuedAt: '2024-04-23T11:26:41.360Z',
                startedAt: '2024-04-23T11:26:41.460Z',
                status: 'COMPLETED',
                stepInfo: null,
                stepOp: 'RUN',
              },
            ],
          },
        ],
      },
    },
  },
};

export const VeryLongStepName: Story = {
  args: {
    app,
    fn,
    getResult: getOutput,
    run: {
      ...run,
      trace: {
        attempts: 1,
        endedAt: '2024-04-23T11:26:43.260Z',
        id: '01HW5CW5E28ZG7GCYSP67ADRND',
        isRoot: true,
        name: 'parallel-recovery',
        outputID: 'MDFIVzVDVzVFMjhaRzdHQ1lTUDY3QURSTkQ=',
        queuedAt: '2024-04-23T11:26:40.260Z',
        startedAt: '2024-04-23T11:26:40.360Z',
        status: 'COMPLETED',
        childrenSpans: [
          {
            attempts: 2,
            endedAt: '2024-04-23T11:26:43.260Z',
            id: '01HW5CY6F5Q3C15CY53Z104WTN',
            isRoot: false,
            name: 'i-am-a-very-long-step-id-whose-purpose-is-to-test-the-layout',
            outputID: 'MDFIVzVDWTZGNVEzQzE1Q1k1M1oxMDRXVE4=',
            queuedAt: '2024-04-23T11:26:40.460Z',
            startedAt: '2024-04-23T11:26:40.560Z',
            status: 'COMPLETED',
            stepInfo: null,
            stepOp: 'RUN',
            childrenSpans: [
              {
                attempts: 1,
                endedAt: '2024-04-23T11:26:42.060Z',
                id: '01HW5D1GRC1AAYJXSNFPC16BHM',
                isRoot: false,
                name: 'Attempt 1',
                outputID: 'MDFIVzVEMUdSQzFBQVlKWFNORlBDMTZCSE0=',
                queuedAt: '2024-04-23T11:26:40.460Z',
                startedAt: '2024-04-23T11:26:40.560Z',
                status: 'FAILED',
                stepInfo: null,
                stepOp: 'RUN',
              },
              {
                attempts: 1,
                endedAt: '2024-04-23T11:26:43.260Z',
                id: '01HW5D23MY4MCX421M0RJ7W3AJ',
                isRoot: false,
                name: 'Attempt 2',
                outputID: 'MDFIVzVEMjNNWTRNQ1g0MjFNMFJKN1czQUo=',
                queuedAt: '2024-04-23T11:26:42.060Z',
                startedAt: '2024-04-23T11:26:42.160Z',
                status: 'COMPLETED',
                stepInfo: null,
                stepOp: 'RUN',
              },
            ],
          },
          {
            attempts: 2,
            endedAt: '2024-04-23T11:26:42.260Z',
            id: '01HW5D84D53Z5KVK4Q35QDNTP4',
            isRoot: false,
            name: 'short-boi',
            outputID: 'MDFIVzVEODRENTNaNUtWSzRRMzVRRE5UUDQ=',
            queuedAt: '2024-04-23T11:26:40.460Z',
            startedAt: '2024-04-23T11:26:40.560Z',
            status: 'COMPLETED',
            stepInfo: null,
            stepOp: 'RUN',
            childrenSpans: [
              {
                attempts: 1,
                endedAt: '2024-04-23T11:26:41.360Z',
                id: '01HW5D9QNGNY5ZRSPQS0RXKM9Q',
                isRoot: false,
                name: 'Attempt 1',
                outputID: 'MDFIVzVEOVFOR05ZNVpSU1BRUzBSWEtNOVE=',
                queuedAt: '2024-04-23T11:26:40.460Z',
                startedAt: '2024-04-23T11:26:40.560Z',
                status: 'FAILED',
                stepInfo: null,
                stepOp: 'RUN',
              },
              {
                attempts: 1,
                endedAt: '2024-04-23T11:26:42.260Z',
                id: '01HW5DA4CA3NHAG5QFJ3KGPVZX',
                isRoot: false,
                name: 'Attempt 2',
                outputID: 'MDFIVzVEQTRDQTNOSEFHNVFGSjNLR1BWWlg=',
                queuedAt: '2024-04-23T11:26:41.360Z',
                startedAt: '2024-04-23T11:26:41.460Z',
                status: 'COMPLETED',
                stepInfo: null,
                stepOp: 'RUN',
              },
            ],
          },
        ],
      },
    },
  },
};

export const LongSleep: Story = {
  args: {
    app,
    fn,
    getResult: getOutput,
    run: {
      ...run,
      trace: {
        attempts: 1,
        endedAt: '2024-04-30T11:26:43.260Z',
        id: '01HW5CW5E28ZG7GCYSP67ADRND',
        isRoot: true,
        name: 'my-fn',
        outputID: 'MDFIVzVDVzVFMjhaRzdHQ1lTUDY3QURSTkQ=',
        queuedAt: '2024-04-23T11:26:40.260Z',
        startedAt: '2024-04-23T11:26:40.560Z',
        status: 'COMPLETED',
        childrenSpans: [
          {
            attempts: 1,
            endedAt: '2024-04-23T11:26:43.260Z',
            id: '01HW5CY6F5Q3C15CY53Z104WTN',
            isRoot: false,
            name: 'step-1',
            outputID: 'MDFIVzVDWTZGNVEzQzE1Q1k1M1oxMDRXVE4=',
            queuedAt: '2024-04-23T11:26:40.460Z',
            startedAt: '2024-04-23T11:26:40.560Z',
            status: 'COMPLETED',
            stepInfo: null,
            stepOp: 'RUN',
            childrenSpans: [
              {
                attempts: 1,
                endedAt: '2024-04-23T11:26:43.260Z',
                id: '01HW5D23MY4MCX421M0RJ7W3AJ',
                isRoot: false,
                name: 'Attempt 1',
                outputID: 'MDFIVzVEMjNNWTRNQ1g0MjFNMFJKN1czQUo=',
                queuedAt: '2024-04-23T11:26:40.460Z',
                startedAt: '2024-04-23T11:26:40.560Z',
                status: 'COMPLETED',
                stepInfo: null,
                stepOp: 'RUN',
              },
            ],
          },
          {
            attempts: 1,
            endedAt: '2024-04-30T11:26:43.260Z',
            id: '01HW5CY6F5Q3C15CY53Z104WTN',
            isRoot: false,
            name: 'long-sleep',
            outputID: 'MDFIVzVDWTZGNVEzQzE1Q1k1M1oxMDRXVE4=',
            queuedAt: '2024-04-23T11:26:40.460Z',
            startedAt: '2024-04-23T11:26:40.560Z',
            status: 'COMPLETED',
            stepInfo: null,
            stepOp: 'RUN',
            childrenSpans: [
              {
                attempts: 1,
                endedAt: '2024-04-30T11:26:43.260Z',
                id: '01HW5D23MY4MCX421M0RJ7W3AJ',
                isRoot: false,
                name: 'Attempt 1',
                outputID: 'MDFIVzVEMjNNWTRNQ1g0MjFNMFJKN1czQUo=',
                queuedAt: '2024-04-23T11:26:40.460Z',
                startedAt: '2024-04-23T11:26:40.560Z',
                status: 'COMPLETED',
                stepInfo: null,
                stepOp: 'RUN',
              },
            ],
          },
        ],
      },
    },
  },
};

export const LotsOfStuff: Story = {
  args: {
    app,
    fn,
    getResult: getOutput,
    run: {
      ...run,
      trace: {
        name: 'local-dev-fn-1',
        status: 'COMPLETED',
        outputID: 'TODO',
        id: 'foo',
        attempts: 1,
        isRoot: true,
        queuedAt: '2024-05-01T21:02:42.498Z',
        startedAt: '2024-05-01T21:02:42.517437635Z',
        endedAt: '2024-05-01T21:04:09.14034905Z',
        stepOp: null,
        stepInfo: null,
        childrenSpans: [
          {
            name: 'run 1',
            status: 'COMPLETED',
            outputID: 'TODO',
            attempts: 1,
            isRoot: false,
            queuedAt: '2024-05-01T21:02:42.507437635Z',
            startedAt: '2024-05-01T21:02:42.517437635Z',
            endedAt: '2024-05-01T21:02:43.041437635Z',
            stepOp: 'RUN',
            id: 'foo',
            stepInfo: null,
            childrenSpans: [
              {
                name: 'Attempt 1',
                status: 'COMPLETED',
                outputID: 'TODO',
                id: 'foo',
                attempts: 1,
                isRoot: false,
                queuedAt: '2024-05-01T21:02:42.507437635Z',
                startedAt: '2024-05-01T21:02:42.517437635Z',
                endedAt: '2024-05-01T21:02:43.041437635Z',
                stepOp: 'RUN',
                stepInfo: null,
              },
            ],
          },
          {
            name: 'sleep',
            status: 'COMPLETED',
            outputID: 'TODO',
            attempts: null,
            isRoot: false,
            queuedAt: '2024-05-01T21:02:43.068534635Z',
            id: 'foo',
            startedAt: '2024-05-01T21:02:43.068534635Z',
            endedAt: '2024-05-01T21:02:48.068534635Z',
            stepOp: 'SLEEP',
            stepInfo: {
              __typename: 'SleepStepInfo',
              sleepUntil: '2024-05-01T21:02:48.068534635Z',
            },
            childrenSpans: [],
          },
          {
            name: 'run 2a',
            status: 'COMPLETED',
            outputID: 'TODO',
            attempts: 3,
            isRoot: false,
            queuedAt: '2024-05-01T21:02:43.07058426Z',
            startedAt: '2024-05-01T21:02:43.08958426Z',
            id: 'foo',
            endedAt: '2024-05-01T21:04:05.943246881Z',
            stepOp: 'RUN',
            stepInfo: null,
            childrenSpans: [
              {
                name: 'Attempt 1',
                status: 'FAILED',
                outputID: 'TODO',
                attempts: 1,
                id: 'foo',
                isRoot: false,
                queuedAt: '2024-05-01T21:02:43.07058426Z',
                startedAt: '2024-05-01T21:02:43.08958426Z',
                endedAt: '2024-05-01T21:02:43.09958426Z',
                stepOp: 'RUN',
                stepInfo: null,
              },
              {
                name: 'Attempt 2',
                status: 'FAILED',
                outputID: 'TODO',
                attempts: 1,
                isRoot: false,
                id: 'foo',
                queuedAt: '2024-05-01T21:02:43.09958426Z',
                startedAt: '2024-05-01T21:03:12.537958385Z',
                endedAt: '2024-05-01T21:03:12.553958385Z',
                stepOp: 'RUN',
                stepInfo: null,
              },
              {
                name: 'Attempt 3',
                status: 'COMPLETED',
                outputID: 'TODO',
                attempts: 1,
                isRoot: false,
                queuedAt: '2024-05-01T21:03:12.553958385Z',
                id: 'foo',
                startedAt: '2024-05-01T21:04:03.910246881Z',
                endedAt: '2024-05-01T21:04:05.943246881Z',
                stepOp: 'RUN',
                stepInfo: null,
              },
            ],
          },
          {
            name: 'run 2b',
            status: 'COMPLETED',
            id: 'foo',
            outputID: 'TODO',
            attempts: 1,
            isRoot: false,
            queuedAt: '2024-05-01T21:02:43.071364094Z',
            startedAt: '2024-05-01T21:02:43.088364094Z',
            endedAt: '2024-05-01T21:02:43.297364094Z',
            stepOp: 'RUN',
            stepInfo: null,
            childrenSpans: [
              {
                name: 'Attempt 1',
                status: 'COMPLETED',
                outputID: 'TODO',
                attempts: 1,
                isRoot: false,
                queuedAt: '2024-05-01T21:02:43.071364094Z',
                id: 'foo',
                startedAt: '2024-05-01T21:02:43.088364094Z',
                endedAt: '2024-05-01T21:02:43.297364094Z',
                stepOp: 'RUN',
                stepInfo: null,
              },
            ],
          },
          {
            name: 'sleep',
            status: 'COMPLETED',
            outputID: 'TODO',
            attempts: null,
            id: 'foo',
            isRoot: false,
            queuedAt: '2024-05-01T21:02:43.310357427Z',
            startedAt: '2024-05-01T21:02:43.310357427Z',
            endedAt: '2024-05-01T21:02:48.310357427Z',
            stepOp: 'SLEEP',
            stepInfo: {
              __typename: 'SleepStepInfo',
              sleepUntil: '2024-05-01T21:02:48.310357427Z',
            },
            childrenSpans: [],
          },
          {
            name: 'send',
            status: 'COMPLETED',
            outputID: 'TODO',
            attempts: 1,
            isRoot: false,
            queuedAt: '2024-05-01T21:04:05.968937424Z',
            startedAt: '2024-05-01T21:04:06.003937424Z',
            id: 'foo',
            endedAt: '2024-05-01T21:04:06.016937424Z',
            stepOp: 'RUN',
            stepInfo: null,
            childrenSpans: [
              {
                name: 'Attempt 1',
                status: 'COMPLETED',
                id: 'foo',
                outputID: 'TODO',
                attempts: 1,
                isRoot: false,
                queuedAt: '2024-05-01T21:04:05.968937424Z',
                startedAt: '2024-05-01T21:04:06.003937424Z',
                endedAt: '2024-05-01T21:04:06.016937424Z',
                stepOp: 'RUN',
                stepInfo: null,
              },
            ],
          },
          {
            name: 'invoke',
            status: 'COMPLETED',
            outputID: 'TODO',
            attempts: null,
            isRoot: false,
            queuedAt: '2024-05-01T21:04:06.018359924Z',
            startedAt: '2024-05-01T21:04:06.025359924Z',
            id: 'foo',
            endedAt: '2024-05-01T21:04:06.029359924Z',
            stepOp: 'INVOKE',
            stepInfo: null,
            childrenSpans: [],
          },
          {
            name: 'wait',
            status: 'WAITING',
            outputID: 'TODO',
            attempts: null,
            isRoot: false,
            queuedAt: '2024-05-01T21:04:06.053996174Z',
            id: 'foo',
            startedAt: '2024-05-01T21:04:06.065996174Z',
            endedAt: '2024-05-01T21:04:06.069996174Z',
            stepOp: 'WAIT_FOR_EVENT',
            stepInfo: null,
            childrenSpans: [],
          },
          {
            name: 'run 3',
            status: 'COMPLETED',
            outputID: 'TODO',
            attempts: 1,
            isRoot: false,
            queuedAt: '2024-05-01T21:04:08.11434905Z',
            id: 'foo',
            startedAt: '2024-05-01T21:04:08.12734905Z',
            endedAt: '2024-05-01T21:04:09.14034905Z',
            stepOp: 'RUN',
            stepInfo: null,
            childrenSpans: [
              {
                name: 'Attempt 1',
                status: 'COMPLETED',
                outputID: 'TODO',
                attempts: 1,
                isRoot: false,
                id: 'foo',
                queuedAt: '2024-05-01T21:04:08.11434905Z',
                startedAt: '2024-05-01T21:04:08.12734905Z',
                endedAt: '2024-05-01T21:04:09.14034905Z',
                stepOp: 'RUN',
                stepInfo: null,
              },
            ],
          },
        ],
      },
    },
  },
};
