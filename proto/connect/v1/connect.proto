syntax = "proto3";
package connect.v1;

option go_package = "github.com/inngest/inngest/proto/gen/connect/v1;connect";

enum GatewayMessageType {
  GATEWAY_HELLO = 0;
  SDK_CONNECT = 1;
  GATEWAY_REQUEST_SYNC = 2;
  GATEWAY_EXECUTOR_REQUEST = 3;
  SDK_REPLY = 4;
}

message ConnectMessage {
	GatewayMessageType kind = 1;
	bytes payload = 2;
}

message SessionDetails {
	string instance_id = 1;
	string connection_id = 2;
	bytes function_hash = 3;
	optional string build_id = 4;
}

message AuthData {
	bytes hashed_signing_key = 1;
}

message SDKConnectRequestData {
	SessionDetails session_details = 1;
	AuthData auth_data = 2;

	string app_name = 3;
	optional string environment = 4;
	optional string framework = 5;
	optional string platform = 6;
	optional string sdk_version = 7;
	optional string sdk_language = 8;
	optional string sdk_author = 9;
}

message GatewaySyncRequestData {
	optional string deploy_id = 1;
}

message GatewayExecutorRequestData {
	string request_id = 1;
	string app_id = 2;
	string function_slug = 3;
	optional string step_id = 4;
	bytes request_payload = 5;
}

enum SDKResponseStatus {
	NOT_COMPLETED = 0;
	DONE = 1;
	ERROR = 2;
}

message SDKResponse {
	string request_id = 1;
	SDKResponseStatus status = 2;
	bytes body = 3;
	bool no_retry = 4;
	optional string retry_after = 5;
	string sdk_version = 6;
}


// Connection metadata
message ConnMetadata {
	SystemAttributes attributes = 1;
	string language = 2;
	string version = 3;
	string env_id = 4;
	string app_id = 5;
	SessionDetails session = 6;
}

message SystemAttributes {
	int32 cpu_cores = 1;
	int64 mem_bytes = 2;
	string os = 3;
}

message ConnGroup {
	string env_id = 1;
	string app_id = 2;
	string hash = 3;
	repeated ConnMetadata conns = 4;
	optional string sync_id = 5;
	optional string build_id = 6;
}
